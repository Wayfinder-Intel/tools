<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Facebook Graph Builder</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Shared CSS -->
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* Tool-specific overrides */
    :root {
      --logo-size: 72px;
    }

    html,
    body {
      overflow: hidden;
    }

    /* App-like feel */

    .container {
      flex: 1;
      min-height: 0;
      padding: 0 20px 20px;
      display: grid;
      grid-template-columns: 440px 1fr;
      gap: 20px;
      overflow: hidden;
      max-width: 100%;
      margin: 0;
    }

    .section {
      padding: 16px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row+.row {
      margin-top: 12px;
    }

    textarea {
      width: 100%;
      min-height: 170px;
      resize: vertical;
      background: rgba(0, 0, 0, 0.2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-family: var(--font-mono);
      line-height: 1.35;
    }

    input[type="text"],
    input[type="range"] {
      background: rgba(0, 0, 0, 0.2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 99px;
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 500;
    }

    .pill.seed {
      color: #7aa2f7;
      border-color: rgba(122, 162, 247, 0.3);
      background: rgba(122, 162, 247, 0.1);
    }

    .pill.node {
      color: #9ece6a;
      border-color: rgba(158, 206, 106, 0.3);
      background: rgba(158, 206, 106, 0.1);
    }

    .seedDisplay {
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px dashed var(--border);
      border-radius: 8px;
      font-size: 13px;
    }

    .grid-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
      max-height: 260px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
    }

    .candidate {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .candidate:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .graph-card {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      padding: 0;
    }

    .graph-controls {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .graph-stage {
      position: relative;
      flex: 1;
      min-height: 0;
      background: #0a0d13;
    }

    svg {
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    svg:active {
      cursor: grabbing;
    }

    svg.light-canvas {
      background: #ffffff;
    }

    /* Inspector */
    .inspector {
      position: absolute;
      right: 16px;
      top: 16px;
      width: 320px;
      background: rgba(21, 25, 35, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      padding: 16px;
      z-index: 10;
    }

    .inspector-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
      margin-bottom: 12px;
    }

    .inspector-title {
      font-weight: 600;
      font-size: 15px;
    }

    /* Dropdowns */
    .dd {
      position: relative;
    }

    .dd-menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 8px;
      min-width: 200px;
      background: #151923;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      padding: 6px;
      display: none;
      z-index: 20;
    }

    .dd.open .dd-menu {
      display: block;
    }

    .dd-item {
      display: block;
      width: 100%;
      text-align: left;
      background: transparent;
      color: var(--text);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .dd-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
        overflow: auto;
      }

      .graph-card {
        min-height: 60vh;
      }
    }
  </style>

  <!-- Shared JS -->
  <script src="js/common.js" defer></script>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-left">
          <a href="index.html">
            <img class="logo" src="Wayfinder.png" alt="Wayfinder Intelligence logo" />
          </a>
          <div>
            <h1 class="title">Facebook Graph Builder</h1>
            <div class="help">One-paste parsing → auto-detect Seed (A) → tick friends → build graph.</div>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Left Column -->
      <div class="card left-card"
        style="display:flex; flex-direction:column; min-height:0; padding:0; overflow:hidden;">
        <div style="flex:1; overflow:auto; padding:20px;">
          <h2>Input & Parsing</h2>
          <div class="section" style="padding:0; margin-bottom:24px;">
            <div class="pill node"
              style="display:inline-block; margin-bottom:12px; background:rgba(158,206,106,0.15); color:#9ece6a; border:1px solid rgba(158,206,106,0.2);">
              Tip: Paste the full block from a Facebook Friends page.
            </div>
            <textarea id="paste" placeholder="Paste here…"></textarea>
            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnPreview">Preview names</button>
              <button class="btn" id="btnClearPaste">Clear</button>
            </div>
          </div>

          <h2>Seed & Candidates</h2>
          <div class="section" style="padding:0; margin-bottom:24px;">
            <div class="row" style="align-items:flex-start">
              <div style="flex:1">
                <div class="small muted mb-4">Detected Seed (A)</div>
                <div id="seedDisplay" class="seedDisplay muted">—</div>
              </div>
              <div style="flex:1">
                <label class="small muted mb-4">Override Seed (A)</label>
                <input type="text" id="seedInput" placeholder="Type to override…" style="width:100%" />
              </div>
            </div>

            <div class="row" style="margin-top:16px; justify-content:space-between;">
              <div>
                <span class="muted small">Candidates (B)</span>
                <button class="btn" id="btnSelectAll"
                  style="padding:4px 8px; font-size:11px; margin-left:8px;">All</button>
                <button class="btn" id="btnSelectNone" style="padding:4px 8px; font-size:11px;">None</button>
              </div>
              <button class="btn primary" id="btnAddEdges">Add seed → selected</button>
            </div>

            <div class="grid-list" id="candidateList" style="margin-top:8px;"></div>
          </div>

          <h2>Session Stopwords</h2>
          <div class="section" style="padding:0;">
            <div class="row">
              <input type="text" id="stopwordInput" placeholder="Add a word/phrase (e.g., 'works at')" style="flex:1" />
              <button class="btn" id="btnAddStopword">Add</button>
            </div>
            <div class="chips" id="stopwordChips" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;"></div>
          </div>
        </div>

        <div
          style="padding:16px; border-top:1px solid var(--border); font-size:12px; color:var(--muted); background:rgba(0,0,0,0.2);">
          OPSEC: Everything you paste remains in this browser tab.
        </div>
      </div>

      <!-- Right Column: Graph -->
      <div class="card graph-card">
        <div class="graph-controls">
          <div class="row" style="justify-content:space-between; gap:12px">
            <div class="legend" style="display:flex; gap:8px;">
              <span class="pill seed">Seed (A)</span>
              <span class="pill node">Node</span>
            </div>

            <div class="row" style="gap:8px">
              <input id="findInput" type="text" placeholder="Find a name…" style="width:180px;">
              <button class="btn" id="btnFind">Find</button>

              <!-- CSV Dropdown -->
              <div class="dd">
                <button class="btn" id="btnCsvMenu">CSV ▾</button>
                <div class="dd-menu" id="csvMenu">
                  <button class="dd-item" id="menuCsvNodes">Nodes CSV</button>
                  <button class="dd-item" id="menuCsvEdges">Edges CSV</button>
                </div>
              </div>

              <button class="btn" id="btnExportPNG">PNG</button>
              <button class="btn" id="btnExport">JSON</button>

              <label for="importJsonInput" class="btn">Import</label>
              <input type="file" id="importJsonInput" accept=".json,application/json" hidden>

              <!-- Sessions Dropdown -->
              <div class="dd">
                <button class="btn" id="btnSessMenu">Sessions ▾</button>
                <div class="dd-menu" id="sessMenu">
                  <button class="dd-item" id="sessSaveCurrent">Save current…</button>
                  <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                  <div id="sessList"></div>
                </div>
              </div>

              <button class="btn" style="color:var(--danger); border-color:rgba(247,118,142,0.3);"
                id="btnWipeGraph">Wipe</button>
            </div>
          </div>

          <div class="row" style="margin-top:16px; gap:20px; font-size:12px; color:var(--muted);">
            <div>
              <div class="mb-4">Physics</div>
              <div class="row">
                <button class="btn" id="btnTogglePhysics">Pause</button>
                <button class="btn" id="btnReheat">Reheat</button>
              </div>
            </div>
            <div>
              <div class="mb-4">Charge</div>
              <input type="range" id="chargeRange" min="-800" max="-50" step="10" value="-240" />
            </div>
            <div>
              <div class="mb-4">Distance</div>
              <input type="range" id="distRange" min="40" max="200" step="5" value="80" />
            </div>
            <div>
              <div class="mb-4">View</div>
              <div class="row">
                <button class="btn" id="btnCenterView">Center</button>
                <button class="btn" id="btnResetZoom">Reset</button>
                <button class="btn" id="btnToggleCanvasBg">White BG</button>
              </div>
            </div>
          </div>
        </div>

        <div class="graph-stage">
          <!-- Inspector -->
          <div id="inspector" class="inspector hidden">
            <div class="inspector-header">
              <div id="inspectorName" class="inspector-title">—</div>
              <button id="inspectorClose" class="btn" style="padding:4px 8px;">✕</button>
            </div>
            <div id="inspectorMeta"
              style="font-size:13px; color:var(--muted); white-space:pre-wrap; margin-bottom:16px;">No extra info.</div>
            <div class="inspector-actions" style="display:flex; gap:8px;">
              <button id="inspectorOpen" class="btn primary" disabled>Open</button>
              <button id="inspectorCopy" class="btn" disabled>Copy Link</button>
              <button id="inspectorDelete" class="btn"
                style="color:var(--danger); border-color:rgba(247,118,142,0.3);">Delete</button>
            </div>
          </div>

          <div id="tooltip" class="tooltip"
            style="position:fixed; pointer-events:none; background:rgba(0,0,0,0.8); padding:6px 10px; border-radius:6px; font-size:12px; z-index:100; opacity:0;">
          </div>
          <svg id="graph"></svg>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script>
    // ===== VERSION TAG =====
    const APP_VERSION = 'GraphBuilder v2.0';

    let nodes = [];
    let links = [];
    let currentRenderNodes = [];
    let currentRenderLinks = [];
    let degreeK = 0;
    let keepSeedsVisible = true;
    const selectedIds = new Set();
    const undoStack = [];
    function idOf(x) { return (x && x.id) ? x.id : x; }

    function snapshotState() {
      return JSON.stringify({
        nodes: nodes.map(n => ({ id: n.id, seed: !!n.seed, url: n.url || null, meta: n.meta || null })),
        links: links.map(l => ({ source: idOf(l.source), target: idOf(l.target) })),
        settings: { degreeK, keepSeedsVisible, chargeStrength, linkDistance, lightCanvas }
      });
    }
    function pushUndo() {
      undoStack.push(snapshotState());
      if (undoStack.length > 30) undoStack.shift();
    }
    function undoLast() {
      if (!undoStack.length) return;
      const snap = undoStack.pop();
      try {
        const data = JSON.parse(snap);
        nodes = data.nodes;
        links = data.links;
        applySettings(data.settings || {});
        selectedIds.clear();
        document.getElementById('inspector').classList.add('hidden');
        restartSimulation(true);
      } catch (e) { }
    }

    const uiWords = ["followers", "training", "household", "institute", "campus", "boutique", "shop", "wellness", "organization", "organisation", "government", "production", "movies", "following", "friends", "mutual friends", "student", "rental", "markets", "club", "rugby", "mutual", "search", "works", "work", "worked", "working", "studied", "studies", "study", "lives", "live", "hometown", "from", "about", "photos", "videos", "reels", "intro", "suggested", "add friend", "message", "posts", "likes", "comments", "public figure", "community", "group", "page", "college", "university", "school", "hospital", "gaming", "memories", "marketplace"].map(s => s.toLowerCase());
    const nzPlaces = ["auckland", "wellington", "christchurch", "hamilton", "tauranga", "dunedin", "palmerston", "rotorua", "nelson", "invercargill", "whangarei", "napier", "hastings", "new plymouth", "porirua", "lower hutt", "upper hutt", "kapiti", "gisborne", "blenheim", "timaru", "queenstown", "taupo", "whanganui", "northland", "waikato", "canterbury", "otago", "southland", "marlborough", "tasman", "wairarapa", "westland", "manawatū", "manawatu", "taranaki"];
    const sessionStopwords = [];
    function addStopword(sw) { const s = (sw || "").trim().toLowerCase(); if (!s) return; if (!sessionStopwords.includes(s)) sessionStopwords.push(s); renderStopwordChips(); if (document.getElementById('paste').value.trim()) reparsePreview(); }
    function removeStopword(sw) { const i = sessionStopwords.indexOf(sw); if (i >= 0) sessionStopwords.splice(i, 1); renderStopwordChips(); if (document.getElementById('paste').value.trim()) reparsePreview(); }
    function cleanLine(s) { return s.replace(/[\u2022•·]+/g, " ").replace(/\s+/g, " ").trim(); }
    function isLocationLine(s) { return s.includes(","); }
    function isStopwordLine(s) {
      const lower = s.toLowerCase();
      if (uiWords.some(w => lower.includes(w))) return true;
      if ((" " + lower + " ").includes(" at ")) return true;
      if (sessionStopwords.some(w => lower.includes(w))) return true;
      const exact = lower.replace(/\./g, "").trim();
      if (nzPlaces.includes(exact)) return true;
      if (nzPlaces.some(p => exact === p + ", nz" || exact === p + ", new zealand")) return true;
      return false;
    }
    function isLikelyName(s) {
      const str = cleanLine(s); if (!str) return false;
      if (/[0-9]/.test(str)) return false;
      if (str.includes("•")) return false;
      if (isLocationLine(str)) return false;
      if (isStopwordLine(str)) return false;
      const words = str.split(/\s+/);
      if (words.length > 6) return false;
      const caps = words.filter(w => /^[A-ZĀĒĪŌŪ][A-Za-zĀāĒēĪīŌōŪū’'\-]+$/.test(w));
      if (words.length >= 2 && caps.length >= 1) return true;
      if (words.length === 1 && /^[A-Z][A-Za-z’'\-]+$/.test(words[0])) return true;
      return false;
    }
    function findFriendsHeaderIndex(lines) {
      for (let i = 0; i < lines.length; i++) { const t = cleanLine(lines[i]).toLowerCase(); if (t === "friends") return i; }
      return -1;
    }
    function detectSeed(lines) {
      const fIdx = findFriendsHeaderIndex(lines);
      const searchEnd = fIdx > 0 ? fIdx : Math.min(lines.length, 6);
      for (let i = 0; i < searchEnd; i++) {
        const s = cleanLine(lines[i]); if (!s) continue;
        if (isStopwordLine(s) || /followers|following/i.test(s)) continue;
        if (isLikelyName(s)) return s;
      }
      for (let i = 0; i < lines.length; i++) { const s = cleanLine(lines[i]); if (s) return s; }
      return "";
    }
    function extractCandidates(lines, seedName) {
      const set = new Set(); const fIdx = findFriendsHeaderIndex(lines); const start = fIdx >= 0 ? fIdx + 1 : 0;
      for (let i = start; i < lines.length; i++) { const raw = cleanLine(lines[i]); if (!raw) continue; if (raw === seedName) continue; if (isLikelyName(raw)) set.add(raw); }
      set.delete(seedName); return Array.from(set);
    }

    const pasteEl = document.getElementById('paste');
    const seedDisplayEl = document.getElementById('seedDisplay');
    const seedInputEl = document.getElementById('seedInput');
    const candidateListEl = document.getElementById('candidateList');
    const stopwordInputEl = document.getElementById('stopwordInput');
    const stopwordChipsEl = document.getElementById('stopwordChips');
    const inspectorEl = document.getElementById('inspector');
    const inspNameEl = document.getElementById('inspectorName');
    const inspMetaEl = document.getElementById('inspectorMeta');
    const inspOpenBtn = document.getElementById('inspectorOpen');
    const inspCopyBtn = document.getElementById('inspectorCopy');
    const inspDeleteBtn = document.getElementById('inspectorDelete');
    const inspCloseBtn = document.getElementById('inspectorClose');

    inspCloseBtn.addEventListener('click', () => inspectorEl.classList.add('hidden'));
    inspOpenBtn.addEventListener('click', () => { const url = inspOpenBtn.dataset.url; if (url) window.open(url, "_blank", "noopener,noreferrer"); });
    inspCopyBtn.addEventListener('click', async () => { const url = inspCopyBtn.dataset.url; if (!url) return; try { await navigator.clipboard.writeText(url); } catch { } });

    function renderStopwordChips() {
      stopwordChipsEl.innerHTML = "";
      if (sessionStopwords.length === 0) return;
      sessionStopwords.forEach(sw => {
        const c = document.createElement('span'); c.className = "pill"; c.style.background = "rgba(255,255,255,0.1)"; c.style.cursor = "pointer";
        c.innerHTML = `${sw} ×`;
        c.addEventListener('click', () => removeStopword(sw));
        stopwordChipsEl.appendChild(c);
      });
    }

    function renderCandidates(list) {
      candidateListEl.innerHTML = "";
      if (!list || list.length === 0) {
        const div = document.createElement('div'); div.className = "muted small"; div.textContent = "No candidate names detected.";
        candidateListEl.appendChild(div); return;
      }
      list.forEach(name => {
        const row = document.createElement('label'); row.className = "candidate";
        const cb = document.createElement('input'); cb.type = "checkbox"; cb.value = name; cb.checked = true;
        const span = document.createElement('span'); span.textContent = name;
        row.appendChild(cb); row.appendChild(span); candidateListEl.appendChild(row);
      });
    }

    let clipboardLinks = new Map();
    let nameMeta = new Map();
    pasteEl.addEventListener('paste', (e) => {
      const dt = e.clipboardData; if (!dt) return;
      const html = dt.getData('text/html'); const plain = dt.getData('text/plain');
      clipboardLinks.clear();
      if (html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        doc.querySelectorAll('a[href]').forEach(a => {
          const name = (a.textContent || '').trim().replace(/\s+/g, ' ');
          const href = a.href;
          if (name && href) clipboardLinks.set(name, href);
        });
        e.preventDefault();
        pasteEl.value = plain || (doc.body ? doc.body.textContent : '');
      }
    });

    function reparsePreview() {
      const text = pasteEl.value || "";
      const rawLines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (rawLines.length === 0) {
        seedDisplayEl.textContent = "—"; seedDisplayEl.dataset.detected = ""; candidateListEl.innerHTML = ""; return;
      }
      const A = detectSeed(rawLines);
      seedDisplayEl.innerHTML = A ? `${A} <span class="muted">(auto-detected)</span>` : "—";
      seedDisplayEl.dataset.detected = A || "";
      seedInputEl.value = A || "";

      nameMeta.clear();
      (function buildMeta() {
        const fIdx = findFriendsHeaderIndex(rawLines);
        const start = fIdx >= 0 ? fIdx + 1 : 0;
        let currentName = null, bucket = [];
        function commit() {
          if (currentName) {
            const trimmed = bucket.map(s => s.trim()).filter(Boolean);
            if (trimmed.length) nameMeta.set(currentName, trimmed);
          }
        }
        for (let i = start; i < rawLines.length; i++) {
          const line = cleanLine(rawLines[i]); if (!line) continue;
          if (isLikelyName(line)) { commit(); currentName = line; bucket = []; }
          else {
            const lower = line.toLowerCase();
            const looksMeta = lower.includes(',') || /works|worked|working|lives|studied|university|college|school|hospital|from|hometown/.test(lower);
            if (looksMeta) bucket.push(line);
          }
        }
        commit();
      })();

      const candidates = extractCandidates(rawLines, A);
      renderCandidates(candidates);
    }

    document.getElementById('btnPreview').addEventListener('click', reparsePreview);
    document.getElementById('btnAddStopword').addEventListener('click', () => { addStopword(stopwordInputEl.value); stopwordInputEl.value = ""; stopwordInputEl.focus(); });
    document.getElementById('btnClearPaste').addEventListener('click', () => { pasteEl.value = ""; seedDisplayEl.textContent = "—"; seedInputEl.value = ""; candidateListEl.innerHTML = ""; });
    document.getElementById('btnSelectAll').addEventListener('click', () => { candidateListEl.querySelectorAll('input[type=checkbox]').forEach(ch => ch.checked = true); });
    document.getElementById('btnSelectNone').addEventListener('click', () => { candidateListEl.querySelectorAll('input[type=checkbox]').forEach(ch => ch.checked = false); });

    function ensureNode(id, seed = false, url = null, meta = null) {
      const existing = nodes.find(n => n.id === id);
      if (!existing) {
        nodes.push({ id, seed: !!seed, url: url || null, meta: meta || null, _promoted: !!seed });
      } else {
        if (seed && !existing.seed) { existing.seed = true; existing._promoted = true; }
        if (url && !existing.url) existing.url = url;
        if (meta && !existing.meta) existing.meta = meta;
      }
    }
    function ensureLink(a, b) {
      const has = links.find(l => idOf(l.source) === a && idOf(l.target) === b);
      if (!has) links.push({ source: a, target: b });
    }

    const svg = d3.select("#graph");
    const gRoot = svg.append("g");
    let gLink = gRoot.append("g").attr("stroke", "#2a3142").attr("stroke-opacity", 0.8);
    let gNode = gRoot.append("g").attr("stroke", "#0a0d13").attr("stroke-width", 1);
    let gLabel = gRoot.append("g").attr("font-size", 11).attr("font-family", "inherit").attr("fill", "#b9c2d6");
    let link = gLink.selectAll("line");
    let node = gNode.selectAll("circle");
    let label = gLabel.selectAll("text");

    const zoom = d3.zoom().scaleExtent([0.25, 4]).on("zoom", (event) => { gRoot.attr("transform", event.transform); });
    svg.call(zoom).on("dblclick.zoom", null);

    let chargeStrength = -240;
    let linkDistance = 80;
    let linkStrength = 0.8;
    let lightCanvas = false;

    const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(() => linkDistance).strength(() => linkStrength))
      .force("charge", d3.forceManyBody().strength(() => chargeStrength))
      .force("center", d3.forceCenter(svg.node().clientWidth / 2, svg.node().clientHeight / 2))
      .force("collide", d3.forceCollide().radius(28))
      .on("tick", ticked);

    function ticked() {
      link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
      node.attr("cx", d => d.x).attr("cy", d => d.y);
      label.attr("x", d => d.x + 10).attr("y", d => d.y + 4);
    }

    function drag(sim) {
      function dragstarted(event, d) {
        if (!event.active) sim.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      }
      function dragged(event, d) {
        d.fx = event.x; d.fy = event.y;
      }
      function dragended(event, d) {
        if (!event.active) sim.alphaTarget(0);
        if (!event.sourceEvent.shiftKey) { d.fx = null; d.fy = null; }
      }
      return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
    }

    function restartSimulation(reheat = false) {
      const renderNodes = nodes;
      const renderLinks = links;

      link = gLink.selectAll("line").data(renderLinks, d => idOf(d.source) + "→" + idOf(d.target)).join("line").attr("stroke-width", 1.4);
      node = gNode.selectAll("circle").data(renderNodes, d => d.id).join("circle")
        .attr("r", d => d.seed ? 9 : 6.5)
        .attr("fill", d => d.seed ? "#7aa2f7" : "#a6da95")
        .call(drag(simulation))
        .on("click", (event, d) => {
          event.stopPropagation();
          inspectorEl.classList.remove('hidden');
          inspNameEl.textContent = d.id;
          inspMetaEl.textContent = Array.isArray(d.meta) && d.meta.length ? d.meta.join("\n") : "No extra info.";
          const url = d.url || "";
          inspOpenBtn.dataset.url = url; inspCopyBtn.dataset.url = url;
          inspOpenBtn.disabled = !url; inspCopyBtn.disabled = !url;
          inspDeleteBtn.onclick = () => {
            nodes = nodes.filter(n => n.id !== d.id);
            links = links.filter(l => idOf(l.source) !== d.id && idOf(l.target) !== d.id);
            restartSimulation();
            inspectorEl.classList.add('hidden');
          };
        });

      label = gLabel.selectAll("text").data(renderNodes, d => d.id).join("text").text(d => d.id);

      if (reheat) simulation.alpha(1).restart();
      else simulation.restart();
    }

    document.getElementById('btnAddEdges').addEventListener('click', () => {
      pushUndo();
      const seedVal = seedInputEl.value.trim() || seedDisplayEl.dataset.detected;
      if (!seedVal) { alert("No seed name identified."); return; }
      const checks = candidateListEl.querySelectorAll('input[type=checkbox]:checked');
      if (checks.length === 0) { alert("No candidates selected."); return; }

      ensureNode(seedVal, true, clipboardLinks.get(seedVal), nameMeta.get(seedVal));
      checks.forEach(ch => {
        const name = ch.value;
        ensureNode(name, false, clipboardLinks.get(name), nameMeta.get(name));
        ensureLink(seedVal, name);
      });
      restartSimulation(true);
    });

    document.getElementById('btnWipeGraph').addEventListener('click', () => {
      if (confirm("Clear graph?")) { pushUndo(); nodes = []; links = []; restartSimulation(); }
    });

    document.getElementById('chargeRange').addEventListener('input', e => { chargeStrength = +e.target.value; simulation.force("charge").strength(chargeStrength); simulation.alpha(0.3).restart(); });
    document.getElementById('distRange').addEventListener('input', e => { linkDistance = +e.target.value; simulation.force("link").distance(linkDistance); simulation.alpha(0.3).restart(); });
    document.getElementById('btnTogglePhysics').addEventListener('click', function () {
      if (this.textContent === 'Pause') { simulation.stop(); this.textContent = 'Resume'; } else { simulation.restart(); this.textContent = 'Pause'; }
    });

    // Initial start
    restartSimulation();
  </script>
</body>

</html>