<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wayfinder EXIF Metadata Inspector</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <!-- EXIF Reader -->
  <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.min.js"></script>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* Tool-specific overrides */
    :root {
      --logo-size: 72px;
    }

    .twocol {
      display: grid;
      grid-template-columns: minmax(420px, 1fr) 420px;
      gap: 20px;
    }

    .preview-holder {
      background: #0b0d12;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid var(--border);
    }

    .preview-img {
      max-width: 100%;
      max-height: 60vh;
      display: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .placeholder {
      color: var(--muted);
      font-size: 14px;
      pointer-events: none;
    }

    .map-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      min-height: 400px;
    }

    .map-wrap {
      flex: 1;
      min-height: 0;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #151923;
    }

    .device-card {
      padding: 16px;
      border-top: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.2);
    }

    .device-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .device-label {
      color: var(--muted);
    }

    .device-val {
      font-weight: 600;
      color: var(--text);
    }

    .drop {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: var(--muted);
      transition: all 0.2s;
      background: rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .drop.dragover {
      border-color: var(--accent);
      background: rgba(122, 162, 247, 0.1);
      color: var(--accent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      padding: 10px 14px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      color: var(--muted);
      font-weight: 600;
      width: 35%;
    }

    td {
      color: var(--text);
      word-break: break-word;
      font-family: var(--font-mono);
    }

    tr:last-child td,
    tr:last-child th {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    @media (max-width: 900px) {
      .twocol {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- Shared JS -->
  <script src="js/common.js" defer></script>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-left">
          <a href="index.html">
            <img class="logo" src="Wayfinder.png" alt="Wayfinder Intelligence logo" />
          </a>
          <div>
            <h1 class="title">EXIF Metadata Inspector</h1>
            <div class="help">Upload or drop an image, or fetch by URL. Nothing leaves your browser.</div>
          </div>
        </div>
      </div>
    </header>

    <main style="padding: 20px; max-width: 1400px; margin: 0 auto;">
      <div class="card mb-4">
        <div class="row" style="padding: 16px; gap: 16px; align-items: center;">
          <label for="file" class="btn primary">Select image</label>
          <input id="file" type="file" accept="image/*" hidden>

          <div id="drop" class="drop" style="flex: 1; padding: 10px;">Drag & drop an image here</div>

          <div style="display: flex; gap: 8px; align-items: center; flex: 1;">
            <input id="urlInput" type="text" placeholder="Or paste image URL..." style="flex: 1;">
            <button id="btnUrl" class="btn">Fetch</button>
          </div>

          <button id="btnExport" class="btn" disabled>Export JSON</button>
          <button id="btnCsv" class="btn" disabled>Export CSV</button>
        </div>
      </div>

      <div class="twocol">
        <!-- Left: Preview -->
        <div class="card">
          <div class="preview-holder">
            <div id="placeholder" class="placeholder">Drop an image or choose a file</div>
            <img id="preview" class="preview-img" alt="Preview" />
          </div>
          <div style="padding: 16px;">
            <h3 style="margin: 0 0 12px; font-size: 15px;">Metadata</h3>
            <div style="max-height: 400px; overflow: auto; border: 1px solid var(--border); border-radius: 8px;">
              <table id="table">
                <tbody>
                  <tr>
                    <td colspan="2" style="text-align:center; color:var(--muted);">No data loaded</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Right: Map & Device -->
        <div class="card map-card">
          <div class="map-wrap">
            <div id="map"></div>
          </div>
          <div class="device-card">
            <div class="device-row">
              <span class="device-label">Device</span>
              <span class="device-val" id="devModel">—</span>
            </div>
            <div class="device-row">
              <span class="device-label">Lens</span>
              <span class="device-val" id="devLens">—</span>
            </div>
            <div class="device-row">
              <span class="device-label">Date</span>
              <span class="device-val" id="devDate">—</span>
            </div>
            <div class="device-row">
              <span class="device-label">Coords</span>
              <span class="device-val" id="devCoords">—</span>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      © 2025 <a href="https://wayfinderintelligence.co.nz" target="_blank" rel="noopener">Wayfinder Intelligence</a> ·
      Experimental tools
    </footer>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const fileInput = $('file');
    const dropZone = $('drop');
    const urlInput = $('urlInput');
    const btnUrl = $('btnUrl');
    const preview = $('preview');
    const placeholder = $('placeholder');
    const tableBody = $('table').querySelector('tbody');
    const btnExport = $('btnExport');
    const btnCsv = $('btnCsv');

    // Map
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);
    let marker;

    let currentMeta = null;

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
      dropZone.addEventListener(e, preventDefaults, false);
      document.body.addEventListener(e, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    ['dragenter', 'dragover'].forEach(e => dropZone.classList.add('dragover'));
    ['dragleave', 'drop'].forEach(e => dropZone.classList.remove('dragover'));

    dropZone.addEventListener('drop', e => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length) handleFile(files[0]);
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) handleFile(fileInput.files[0]);
    });

    btnUrl.addEventListener('click', () => {
      const u = urlInput.value.trim();
      if (u) handleUrl(u);
    });

    function reset() {
      preview.style.display = 'none';
      preview.src = '';
      placeholder.style.display = 'block';
      tableBody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:var(--muted);">No data loaded</td></tr>';
      $('devModel').textContent = '—';
      $('devLens').textContent = '—';
      $('devDate').textContent = '—';
      $('devCoords').textContent = '—';
      if (marker) map.removeLayer(marker);
      map.setView([0, 0], 2);
      currentMeta = null;
      btnExport.disabled = true;
      btnCsv.disabled = true;
    }

    async function handleFile(file) {
      reset();
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.onload = () => {
        preview.style.display = 'block';
        placeholder.style.display = 'none';
      };
      processImage(file);
    }

    async function handleUrl(url) {
      reset();
      // Proxy warning: this might fail due to CORS if not proxied or allowed.
      // Since we are client-side only, we can only fetch CORS-enabled images.
      try {
        const res = await fetch(url);
        const blob = await res.blob();
        handleFile(blob);
      } catch (e) {
        alert('Could not fetch image (CORS restriction?): ' + e);
      }
    }

    async function processImage(file) {
      try {
        const output = await exifr.parse(file, {
          tiff: true, ifd0: true, ifd1: true, exif: true, gps: true,
          interop: true, xmp: true, icc: true, iptc: true,
          mergeOutput: false
        });

        // Flatten for display
        const flat = {};
        if (output) {
          for (let section in output) {
            if (typeof output[section] === 'object') {
              for (let k in output[section]) {
                flat[k] = output[section][k];
              }
            }
          }
        }

        currentMeta = flat;
        renderTable(flat);
        renderDevice(flat);

        // GPS
        if (flat.latitude && flat.longitude) {
          const lat = flat.latitude;
          const lon = flat.longitude;
          $('devCoords').textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
          map.setView([lat, lon], 13);
          marker = L.marker([lat, lon]).addTo(map);
        }

        btnExport.disabled = false;
        btnCsv.disabled = false;

      } catch (e) {
        console.error(e);
        tableBody.innerHTML = `<tr><td colspan="2" style="text-align:center; color:var(--danger);">Error parsing EXIF: ${e.message}</td></tr>`;
      }
    }

    function renderTable(data) {
      if (!data || Object.keys(data).length === 0) {
        tableBody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:var(--muted);">No metadata found</td></tr>';
        return;
      }
      let html = '';
      // Sort keys
      const keys = Object.keys(data).sort();
      for (const k of keys) {
        let val = data[k];
        if (val instanceof Date) val = val.toLocaleString();
        if (typeof val === 'object') val = JSON.stringify(val);
        if (String(val).length > 100) val = String(val).substring(0, 100) + '...';
        html += `<tr><th>${k}</th><td>${val}</td></tr>`;
      }
      tableBody.innerHTML = html;
    }

    function renderDevice(data) {
      const model = data.Model || data.Make || '—';
      const lens = data.LensModel || data.Lens || '—';
      const date = data.DateTimeOriginal || data.CreateDate || data.ModifyDate || '—';

      $('devModel').textContent = model;
      $('devLens').textContent = lens;
      $('devDate').textContent = (date instanceof Date) ? date.toLocaleString() : date;
    }

    btnExport.addEventListener('click', () => {
      if (!currentMeta) return;
      const blob = new Blob([JSON.stringify(currentMeta, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'metadata.json';
      a.click();
    });

    btnCsv.addEventListener('click', () => {
      if (!currentMeta) return;
      const keys = Object.keys(currentMeta).sort();
      const rows = ['Key,Value'];
      for (const k of keys) {
        let val = currentMeta[k];
        if (val instanceof Date) val = val.toISOString();
        if (typeof val === 'object') val = JSON.stringify(val);
        rows.push(`"${k}","${String(val).replace(/"/g, '""')}"`);
      }
      const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'metadata.csv';
      a.click();
    });

  </script>
</body>

</html>